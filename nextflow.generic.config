/*
========================================================================================
    eccoDNA Project-Specific Nextflow Configuration
========================================================================================
*/

// Project-specific parameters
params {
    // Project information
    project_name = 'Project Name'
    marker = 'Marker'  // Default marker for this project
    
    // Path where containers are stored
    container_base = "/containers"
    
    // Input/Output (relative to this project directory)
    input = 'samplesheet.csv'
    outdir = 'results'
    
    // Marker-specific parameters
    // Marker-specific parameters
    markers {
        FISHE {
            min_length = 223
            max_length = 232
            forward_primer = 'ACYAANCAYAAAGAYATNGGCAC'
            reverse_primer = 'CTTATRTTRTTTATNCGNGGRAANGC'
        }
        MIFISHU {
            min_length = 163
            max_length = 185
            forward_primer = 'NNNNNNGTCGGTAAAACTCGTGCCAGC'
            reverse_primer = 'NNNNNNCATAGTGGGGTATCTAATCCCAGTTTG'
        }
        MCINNES16S {
            min_length = 180
            max_length = 205
            forward_primer = 'AGCGYAATCACTTGTCTYTTAA'
            reverse_primer = 'CRBGGTCGCCCCAACCRAA'
        }
    }
    
    // PEAR parameters
    pear {
        quality_threshold = 26
        min_overlap = 10
    }
    
    // VSEARCH parameters
    vsearch {
        max_ee = 1
        min_len = 50
        max_len = 300
        minuniquesize = 2
        minsize = 8
        unoise_alpha = 2
        identity_threshold = 0.97
    }
    
    // BLAST parameters - PROJECT SPECIFIC DATABASE
    blast {
        database = '/blastdb'
        db = 'nt_euk'
        evalue = 0.01
        max_target_seqs = 10
        outfmt = '6 qseqid sseqid pident evalue length qcovs ssciname sblastname scomname staxid'
    }
    
    // SSS filtering
    sss {
        min_threshold = 99.0
        apply_filter = true
    }
        
    // Options
    skip_blast = false
    skip_sss_filter = false
    help = false
}

// Process resources (same across projects)
process {
    cpus = 2
    memory = 8.GB
    time = 16.h
    
    withName: MERGE_READS {
        cpus = 8
        memory = 16.GB
        time = 4.h
    }
    
    withName: QUALITY_FILTER {
        cpus = 4
        memory = 8.GB
        time = 4.h
    }
    
    withName: CONCATENATE {
        cpus = 1
        memory = 4.GB
        time = 1.h
    }
    
    withName: DEREPLICATE {
        cpus = 8
        memory = 32.GB
        time = 8.h
    }
    
    withName: DENOISE {
        cpus = 16
        memory = 64.GB
        time = 16.h
    }
    
    withName: CHIMERA_REMOVAL {
        cpus = 8
        memory = 32.GB
        time = 8.h
    }
    
    withName: LENGTH_FILTER {
        cpus = 2
        memory = 4.GB
        time = 1.h
    }
    
    withName: GENERATE_ASV_TABLE {
        cpus = 64
        memory = 250.GB
        time = 24.h
    }
    
    withName: BLAST_TAXONOMY {
        cpus = 64
        memory = 250.GB
        time = 24.h
    }
    
    withName: FILTER_SSS {
        cpus = 4
        memory = 16.GB
        time = 2.h
    }
}

// SLURM profile
profiles {
    slurm {
        process {
            executor = 'slurm'
            clusterOptions = '--account=account --partition=standard --comment="comment"'
            
            withName: MERGE_READS {
                container = "${params.container_base}/pear.0.9.6.3.sif"
            }
            withName: '.*QUALITY_FILTER|.*DEREPLICATE|.*DENOISE|.*CHIMERA_REMOVAL|.*GENERATE_ASV_TABLE' {
                container = "${params.container_base}/vsearch.2.21.1.sif"
            }
            withName: LENGTH_FILTER {
                container = "${params.container_base}/seqkit.2.3.0.sif"
            }
            withName: BLAST_TAXONOMY {
                container = "${params.container_base}/blast.2.1.3.sif"
            }
            withName: FILTER_SSS {
                container = "${params.container_base}/pandas.1.5.2.sif"
            }
        }

        // Apptainer settings
        apptainer.enabled = true
        apptainer.autoMounts = true
        apptainer.runOptions = '--bind /blastdb'
        
        // Metadata settings
        dag.overwrite = true
        report.overwrite = true
        timeline.overwrite = true
        trace.overwrite = true

        executor {
            queueSize = 100
            submitRateLimit = '10 sec'
        }
    }

    local {
        process {
            executor = 'local'
            
            withName: MERGE_READS {
                container = "${params.container_base}/pear.0.9.6.3.sif"
            }
            withName: '.*QUALITY_FILTER|.*DEREPLICATE|.*DENOISE|.*CHIMERA_REMOVAL|.*GENERATE_ASV_TABLE' {
                container = "${params.container_base}/vsearch.2.21.1.sif"
            }
            withName: LENGTH_FILTER {
                container = "${params.container_base}/seqkit.2.3.0.sif"
            }
            withName: BLAST_TAXONOMY {
                container = "${params.container_base}/blast.2.1.3.sif"
            }
            withName: FILTER_SSS {
                container = "${params.container_base}/pandas.1.5.2.sif"
            }
        }

        // Apptainer settings
        apptainer.enabled = true
        apptainer.autoMounts = true
        apptainer.runOptions = "--bind ${params.blast.database}"

    }
}

// Execution reports (saved in project directory)
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}

// Manifest
manifest {
    name = 'eccoDNA'
    author = 'Author name'
    description = "${params.project_name} ${params.marker}"
    mainScript = 'main.nf'
    nextflowVersion = '>=22.10.0'
    version = '1.0.0'
}
